name: Deploy FastAPI Backend to Serverless

on:
  push:
    branches:
      - 001-textbook-platform

jobs:
  deploy:
    name: Deploy FastAPI Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker image
        id: docker_build
        uses: docker/build-push-action@v4
        with:
          context: ./backend # Path to your backend Dockerfile context
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/fastapi-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Docker image
        id: docker_build
        uses: docker/build-push-action@v4
        with:
          context: ./backend # Path to your backend Dockerfile context
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/fastapi-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Render Deployment Instructions
        run: |
          echo "--- Deployment to Render ---"
          echo "To deploy to Render, you will need to create a new Web Service on Render."
          echo "1. Go to https://dashboard.render.com/ and create a new Web Service."
          echo "2. Connect your GitHub repository."
          echo "3. Choose 'Docker' for the environment and point to your 'backend' directory."
          echo "4. Render will automatically build and deploy your Dockerfile."
          echo "   Alternatively, you can connect to your Docker Hub image: ${{ secrets.DOCKER_USERNAME }}/fastapi-backend:latest"
          echo "5. Configure environment variables (like database credentials, Qdrant API key) directly in Render."
          echo "6. Ensure your service is set to listen on port 8000, as configured in your Dockerfile."
          echo "7. Refer to Render's documentation for more details: https://render.com/docs/deploy-docker"
